#!/usr/bin/env bash
set -o pipefail
set +e

SCRIPT_PATH=$(dirname "$0"); SCRIPT_PATH=$(eval "cd \"$SCRIPT_PATH\" && pwd")
OUTPUT_FILE=${OUTPUT_FILE:-"./output.txt"}
JUNIT_FILE=${JUNIT_FILE:-"./junit.xml"}
GO_TEST_TIMEOUT=${GO_TEST_TIMEOUT:-"10m"}
EXTRA_FLAGS=""

# Install gotestsum as test runner
echo "Installing gotestsum..."
go install gotest.tools/gotestsum@v1.12.3
PATH=$PATH:$(go env GOPATH)/bin
export PATH

# Setup test flags based on event type
echo "Running go_core_tests_integration for event: $GITHUB_EVENT_NAME"
GO_TEST_FLAGS="-timeout=${GO_TEST_TIMEOUT}"
if [[ "$GITHUB_EVENT_NAME" == 'push' ]]; then
  GO_TEST_FLAGS="$GO_TEST_FLAGS -count=1"
elif [[ "$GITHUB_EVENT_NAME" == 'schedule' ]]; then
  # Experimental code to minimize size of this coverage report
  # ALL_IMPORTS=$(go list -f '{{ join .Imports "\n" }}' $INTEGRATION_TEST_DIRS | sort -u)
  # COVERPKG_DIRS=$(echo "$INTEGRATION_TEST_DIRS $ALL_IMPORTS" | grep "smartcontractkit/chainlink" | tr '\n' ',')
  GO_TEST_FLAGS="$GO_TEST_FLAGS -covermode=atomic -coverpkg=./... -coverprofile=coverage.txt"
elif [[ "$GITHUB_EVENT_NAME" == 'pull_request' || "$GITHUB_EVENT_NAME" == 'merge_group' ]]; then
  RERUN_FLAGS=""
  if [[ "$TRUNK_AUTO_QUARANTINE" != "true" ]]; then
    echo "TRUNK_AUTO_QUARANTINE disabled, allowing for gotestsum to rerun failed tests"
    RERUN_FLAGS="--rerun-fails-abort-on-data-race --rerun-fails=3"
  else
    echo "TRUNK_AUTO_QUARANTINE enabled, gotestsum will not rerun failed tests"
  fi
fi

if [[ "$PRODUCE_JUNIT_XML" == "true" ]]; then
  JUNIT_FLAG="--junitfile=$JUNIT_FILE"
fi


# Find integtration-tagged tests
echo "Finding and running integration-tagged tests"
INTEGRATION_TAGGED_TEST_FILES=$(find . -name '*_test.go' -exec grep -l '//go:build integration' {} +)
if [[ -z $INTEGRATION_TAGGED_TEST_FILES ]]; then
  echo "No integration-tagged tests found."
  exit 0
fi
INTEGRATION_TEST_DIRS=$(echo "$INTEGRATION_TAGGED_TEST_FILES" | xargs -n1 dirname | sort -u)
INTEGRATION_TEST_DIRS_SPACE_DELIMITED=$(echo "$INTEGRATION_TEST_DIRS" | tr '\n' ' ')

echo "Using GO_TEST_FLAGS: $GO_TEST_FLAGS"
echo "Using RERUN_FLAGS: $RERUN_FLAGS"
echo "Using JUNIT_FLAG: $JUNIT_FLAG"
echo "Using TEST_DIRS: $INTEGRATION_TEST_DIRS_SPACE_DELIMITED"

echo "Test execution results: ---------------------"
echo ""

# For matching `go test` output - use --format='standard-quiet' and --hide-summary=skipped
# For matching `go test -v` output - use only --format='standard-verbose'
gotestsum \
  --format='standard-quiet' \
  --hide-summary=skipped \
  $RERUN_FLAGS \
  --jsonfile "$OUTPUT_FILE" \
  "$JUNIT_FLAG" \
  -- --tags integration $GO_TEST_FLAGS $INTEGRATION_TEST_DIRS_SPACE_DELIMITED

EXITCODE=${PIPESTATUS[0]}

# Assert no known sensitive strings present in test logger output
printf "\n----------------------------------------------\n\n"
echo "Beginning check of output logs for sensitive strings"
$SCRIPT_PATH/scrub_logs $OUTPUT_FILE
if [[ $? != 0 ]]; then
  exit 1
fi

echo "Exit code: $EXITCODE"
if [[ $EXITCODE != 0 ]]; then
  echo "Encountered test failures."
else
  echo "All tests passed!"
fi
echo "go_core_tests exiting with code $EXITCODE"
exit $EXITCODE
